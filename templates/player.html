{% extends "base.html" %}

{% block content %}
<div class="dashboard-root" style="max-width: 1000px;">
    
    <div class="interactive-card" style="display: flex; align-items: center; gap: 20px; margin-bottom: 40px; text-align: left;">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-blue), #c084fc); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: #fff;">
            {{ player.name[0] }}
        </div>
        <div>
            <h1 style="margin: 0; font-size: 2.5rem;">{{ player.name }}</h1>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <span style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">
                    {{ player.type | upper }}
                </span>
                <span style="color: var(--text-muted);"># {{ player.id }}</span>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
        
        <div class="interactive-card chart-card">
            <div id="stat-chart" style="width:100%; height:400px;"></div>
        </div>

        <div class="interactive-card chart-card">
            <div id="pie-chart" style="width:100%; height:400px;"></div>
        </div>
        
    </div>
</div>

<div id="player-data" data-player='{{ player | tojson | safe }}' style="display:none;"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const player = JSON.parse(document.getElementById('player-data').dataset.player);

    // 深色主題設定 (關鍵)
    const darkLayout = {
        paper_bgcolor: 'rgba(0,0,0,0)', // 透明背景
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#f1f5f9', family: 'Inter, sans-serif' },
        xaxis: { gridcolor: '#334155', showgrid: true, zerolinecolor: '#475569' },
        yaxis: { gridcolor: '#334155', showgrid: true, zerolinecolor: '#475569' },
        margin: { t: 50, b: 50, l: 50, r: 20 }
    };

    // 1. 繪製長條圖
    function drawBarChart(player) {
        let xValues, yValues, barColors, title;

        if (player.type === 'batter') {
            xValues = ['AVG', 'OBP', 'SLG', 'OPS'];
            yValues = [player.avg, player.obp, player.slg, player.ops];
            barColors = ['#3b82f6', '#3b82f6', '#3b82f6', '#34d399']; 
            title = "打擊三圍 & OPS";
        } else {
            xValues = ['WHIP', 'ERA'];
            yValues = [player.whip, player.era];
            barColors = ['#f59e0b', '#ef4444']; 
            title = "投手關鍵數據";
        }

        const trace = {
            x: xValues, y: yValues, type: "bar",
            text: yValues.map(String), textposition: 'auto',
            marker: { color: barColors }
        };

        const layout = Object.assign({}, darkLayout, { title: title });
        Plotly.newPlot("stat-chart", [trace], layout, {displayModeBar: false});
    }

    // 2. 繪製圓餅圖
    function drawPieChart(player) {
        let labels, values, colors, title;

        if (player.type === 'batter') {
            labels = ['一壘安打', '二壘安打', '三壘安打', '全壘打', '出局'];
            values = [player['1b'], player['2b'], player['3b'], player.hr, player.out];
            colors = ['#3b82f6', '#10b981', '#8b5cf6', '#ef4444', '#475569'];
            title = "打席結果分佈";
        } else {
            labels = ['三振 (SO)', '保送 (BB)'];
            values = [player.so, player.bb];
            colors = ['#f59e0b', '#3b82f6'];
            title = "三振 vs 保送";
        }

        // 過濾 0 的數據
        const finalData = labels.map((label, i) => ({label, value: values[i], color: colors[i]})).filter(d => d.value > 0);

        if (finalData.reduce((a, b) => a + b.value, 0) === 0) {
            document.getElementById('pie-chart').innerHTML = `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:#64748b;">無詳細數據</div>`;
            return;
        }

        const trace = {
            values: finalData.map(d => d.value),
            labels: finalData.map(d => d.label),
            type: 'pie',
            hole: 0.5, // 甜甜圈圖比較有質感
            marker: { colors: finalData.map(d => d.color) },
            textinfo: 'label+percent',
            textposition: 'outside',
            textfont: { color: '#f1f5f9' } // 標籤字體變白
        };

        const layout = Object.assign({}, darkLayout, { 
            title: title,
            showlegend: false // 隱藏圖例讓畫面乾淨
        });
        
        Plotly.newPlot("pie-chart", [trace], layout, {displayModeBar: false});
    }

    drawBarChart(player);
    drawPieChart(player);
</script>
{% endblock %}