{% extends "base.html" %}

{% block content %}
<div class="page-card">
    <h2 style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; color: #fff;">
        {{ team_name }} 隊伍詳情
    </h2>

    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 40px;">
        <div id="scatter" style="flex: 1; min-width: 300px; height: 450px; cursor: pointer;"></div>
        <div id="bar" style="flex: 1; min-width: 300px; height: 450px; cursor: pointer;"></div>
    </div>
</div>

<div id="team-data-storage"
     data-pitchers='{{ pitchers | tojson | safe }}'
     data-batters='{{ batters | tojson | safe }}'
     style="display:none;">
</div>

<script>
    const dataDiv = document.getElementById('team-data-storage');
    const pitchersData = dataDiv ? JSON.parse(dataDiv.dataset.pitchers) : [];
    const battersData = dataDiv ? JSON.parse(dataDiv.dataset.batters) : [];

    const layoutConfig = {
        font: { color: '#f1f5f9' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { gridcolor: '#334155', showgrid: true },
        yaxis: { gridcolor: '#334155', showgrid: true },
        margin: { t: 40, b: 80, l: 50, r: 20 }
    };

    // 1. 繪製投手散點圖
    if (pitchersData && pitchersData.length > 0) {
        const pTrace = {
            x: pitchersData.map(p => p.whip || 0),
            y: pitchersData.map(p => p.k9 || 0),
            mode: 'markers',
            type: 'scatter',
            text: pitchersData.map(p => p.name),
            // 【整合點】加入 customdata 存 ID，方便點擊跳轉
            customdata: pitchersData.map(p => p.id), 
            marker: { size: 14, color: '#3b82f6', line: {color: 'white', width: 1}, opacity: 0.8 }
        };
        
        const pLayout = Object.assign({}, layoutConfig, {
            title: '投手進階數據 (WHIP vs K/9) - 點擊查看球員',
            xaxis: Object.assign({}, layoutConfig.xaxis, { title: 'WHIP' }),
            yaxis: Object.assign({}, layoutConfig.yaxis, { title: 'K/9' }),
            hovermode: 'closest'
        });

        Plotly.newPlot('scatter', [pTrace], pLayout, {displayModeBar: false});

        // 【整合點】加入點擊事件監聽 (這是組員在 main 分支加的功能)
        document.getElementById('scatter').on('plotly_click', function(data){
            if(data.points.length > 0) {
                // 取得我們藏在 customdata 裡的 player_id
                const playerId = data.points[0].customdata;
                if(playerId) {
                    window.location.href = `/player/${playerId}`;
                }
            }
        });
    }

    // 2. 繪製打者 OPS 長條圖
    if (battersData && battersData.length > 0) {
        const topBatters = battersData.sort((a, b) => (b.ops || 0) - (a.ops || 0)).slice(0, 15);
        
        const bTrace = {
            x: topBatters.map(p => p.name),
            y: topBatters.map(p => p.ops || 0),
            type: 'bar',
            // 【整合點】加入 customdata
            customdata: topBatters.map(p => p.id),
            marker: { color: '#34d399' }
        };

        const bLayout = Object.assign({}, layoutConfig, {
            title: '打者 OPS 排行 - 點擊查看球員',
            xaxis: Object.assign({}, layoutConfig.xaxis, { tickangle: -45 }),
            yaxis: Object.assign({}, layoutConfig.yaxis, { title: 'OPS' })
        });

        Plotly.newPlot('bar', [bTrace], bLayout, {displayModeBar: false});

        // 【整合點】加入點擊事件監聽
        document.getElementById('bar').on('plotly_click', function(data){
            if(data.points.length > 0) {
                const playerId = data.points[0].customdata;
                if(playerId) {
                    window.location.href = `/player/${playerId}`;
                }
            }
        });
    }
</script>
{% endblock %}