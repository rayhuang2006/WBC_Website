{% extends "base.html" %}

{% block content %}
<style>
.player-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin: 8px 0 16px 0;
  padding: 0;
}
.player-item {
  padding: 6px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: #f9f9f9;
  word-break: keep-all;
}
/* 讓圖表顯示為可點擊狀態 */
#scatter, #bar { cursor: pointer; }
/* 本頁主要標題顏色覆寫（僅限此模板） */
.team-page-title,
.team-page-subtitle,
.team-section-title {
  color: #000000;
}
@media (max-width: 700px) {
  .player-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>

<h2 class="team-page-title">{{ team_name }} 隊伍</h2>

<h3 class="team-page-subtitle">球員名單</h3>

{% set pitchers = players|selectattr('type','equalto','pitcher')|list %}
{% set batters  = players|selectattr('type','equalto','batter')|list %}

<h4 class="team-section-title">投手</h4>
<div class="player-grid">
  {% for p in pitchers %}
  <div class="player-item"><a href="/player/{{ p.id }}">{{ p.name }}</a></div>
  {% else %}
  <div class="player-item">無投手資料</div>
  {% endfor %}
</div>

<h4 class="team-section-title">打者</h4>
<div class="player-grid">
  {% for p in batters %}
  <div class="player-item"><a href="/player/{{ p.id }}">{{ p.name }}</a></div>
  {% else %}
  <div class="player-item">無打者資料</div>
  {% endfor %}
</div>
<div id="scatter"></div>
<div id="bar" style="margin-top:30px;"></div>

<script>
const playersData = {{ players | tojson }};

const pitchersData = playersData.filter(p => p.type === "pitcher");
const battersData  = playersData.filter(p => p.type === "batter");

// 投手散點圖（WHIP vs K/9）
const pitcherTrace = {
    x: pitchersData.map(p => p.whip || 0),
    y: pitchersData.map(p => p.k9 || 0),
    mode: "markers",
    type: "scatter",
    name: "投手 (WHIP vs K/9)",
    text: pitchersData.map(p => p.name)
};

const scatterLayout = {
    title: "投手散點圖",
    xaxis: { title: "WHIP" },
    yaxis: { title: "K/9" }
};

Plotly.newPlot("scatter", [pitcherTrace], scatterLayout);

// 打者 OPS 長條圖
const barTrace = {
    x: battersData.map(p => p.name),
    y: battersData.map(p => p.ops || 0),
    type: "bar",
    name: "打者 OPS",
    marker: { color: "orange" },
    text: battersData.map(p => p.ops != null ? p.ops : "")
};

const barLayout = {
    title: "打者 OPS 長條圖",
    xaxis: { title: "球員名稱", tickangle: -45 },
    yaxis: { title: "OPS" },
    margin: { b: 140 }
};

Plotly.newPlot("bar", [barTrace], barLayout);

// 點擊圖表導向球員頁面
(function(){
  const scatterDiv = document.getElementById('scatter');
  if (scatterDiv && typeof scatterDiv.on === 'function') {
    scatterDiv.on('plotly_click', function(data){
      try {
        const pt = data.points && data.points[0];
        if (!pt) return;
        const idx = pt.pointIndex;
        const player = pitchersData[idx];
        if (player && player.id) {
          window.location.href = `/player/${player.id}`;
        }
      } catch (e) {
        console.error('scatter click error', e);
      }
    });
  }

  const barDiv = document.getElementById('bar');
  if (barDiv && typeof barDiv.on === 'function') {
    barDiv.on('plotly_click', function(data){
      try {
        const pt = data.points && data.points[0];
        if (!pt) return;
        const idx = pt.pointIndex;
        const player = battersData[idx];
        if (player && player.id) {
          window.location.href = `/player/${player.id}`;
        }
      } catch (e) {
        console.error('bar click error', e);
      }
    });
  }
})();
</script>

{% endblock %}
