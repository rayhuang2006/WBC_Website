{% extends "base.html" %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
    <div>
        <h2 style="margin:0; font-size: 2rem; color: #fff;">{{ team_name }} éšŠä¼è©³æƒ…</h2>
    </div>
    <a href="/" class="nav-btn">&larr; è¿”å›é¦–é </a>
</div>

<div style="display: flex; flex-direction: column; gap: 40px;">

    <section>
        <h3 style="color: var(--accent-blue); margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
            æŠ•æ‰‹é™£å®¹ (Pitchers)
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 20px; justify-items: center;">
            {% for p in pitchers %}
            <a href="/player/{{ p.id }}" class="interactive-card mini-player-card">
                <div class="player-icon-placeholder" style="color: var(--accent-blue);">
                    <span>ğŸ§¢</span>
                </div>
                <div class="player-name">{{ p.name }}</div>
                <div class="player-pos" style="color: var(--accent-blue);">Pitcher</div>
            </a>
            {% else %}
            <div style="color: #888; grid-column: 1 / -1; text-align: center;">æš«ç„¡æŠ•æ‰‹è³‡æ–™</div>
            {% endfor %}
        </div>
    </section>

    <section>
        <h3 style="color: #34d399; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
            æ‰“è€…é™£å®¹ (Batters)
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 20px; justify-items: center;">
            {% for p in batters %}
            <a href="/player/{{ p.id }}" class="interactive-card mini-player-card">
                <div class="player-icon-placeholder" style="color: #34d399;">
                    <span>âš¾</span>
                </div>
                <div class="player-name">{{ p.name }}</div>
                <div class="player-pos" style="color: #34d399;">Batter</div>
            </a>
            {% else %}
            <div style="color: #888; grid-column: 1 / -1; text-align: center;">æš«ç„¡æ‰“è€…è³‡æ–™</div>
            {% endfor %}
        </div>
    </section>

    <section style="margin-top: 20px;">
        <h3 style="color: #fff; margin-bottom: 20px;">éšŠä¼æ•¸æ“šåˆ†æ (é»æ“Šåœ–è¡¨å¯æŸ¥çœ‹çƒå“¡)</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 30px;">
            <div class="interactive-card chart-card" style="flex: 1; min-width: 300px; height: 450px;">
                <div id="scatter" style="width:100%; height:100%;"></div>
            </div>
            <div class="interactive-card chart-card" style="flex: 1; min-width: 300px; height: 450px;">
                <div id="bar" style="width:100%; height:100%;"></div>
            </div>
        </div>
    </section>

</div>

<div id="team-data-storage"
     data-pitchers='{{ pitchers | tojson | safe }}'
     data-batters='{{ batters | tojson | safe }}'
     style="display:none;">
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script>
    const dataDiv = document.getElementById('team-data-storage');
    const pitchersData = dataDiv ? JSON.parse(dataDiv.dataset.pitchers) : [];
    const battersData = dataDiv ? JSON.parse(dataDiv.dataset.batters) : [];

    const layoutConfig = {
        font: { color: '#f1f5f9' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { gridcolor: '#334155', showgrid: true },
        yaxis: { gridcolor: '#334155', showgrid: true },
        margin: { t: 50, b: 50, l: 60, r: 20 },
        autosize: true
    };

    // --- 1. ç¹ªè£½æŠ•æ‰‹æ•£é»åœ– ---
    if (pitchersData && pitchersData.length > 0) {
        const pTrace = {
            x: pitchersData.map(p => p.whip || 0),
            y: pitchersData.map(p => p.k9 || 0),
            mode: 'markers',
            type: 'scatter',
            text: pitchersData.map(p => p.name),
            // åŠ å…¥ customdata ç”¨æ–¼é»æ“Šè·³è½‰
            customdata: pitchersData.map(p => p.id),
            marker: { 
                size: 14, 
                color: pitchersData.map(p => p.k9 || 0),
                colorscale: 'Blues',
                reversescale: true,
                line: {color: 'white', width: 1},
                opacity: 0.8
            }
        };
        
        const pLayout = Object.assign({}, layoutConfig, {
            title: 'æŠ•æ‰‹é€²éšæ•¸æ“š (WHIP vs K/9)',
            xaxis: Object.assign({}, layoutConfig.xaxis, { title: 'WHIP (æ¯å±€è¢«ä¸Šå£˜ç‡)' }),
            yaxis: Object.assign({}, layoutConfig.yaxis, { title: 'K/9 (æ¯ä¹å±€ä¸‰æŒ¯æ•¸)' }),
            hovermode: 'closest'
        });

        Plotly.newPlot('scatter', [pTrace], pLayout, {displayModeBar: false});

        // ç¶å®šé»æ“Šäº‹ä»¶ (çµ„å“¡çš„åŠŸèƒ½)
        document.getElementById('scatter').on('plotly_click', function(data){
            if(data.points.length > 0) {
                const playerId = data.points[0].customdata;
                if(playerId) window.location.href = `/player/${playerId}`;
            }
        });

    } else {
        document.getElementById('scatter').innerHTML = '<div style="height:100%; display:flex; justify-content:center; align-items:center; color:#888;">ç„¡è¶³å¤ æ•¸æ“šç¹ªè£½åœ–è¡¨</div>';
    }

    // --- 2. ç¹ªè£½æ‰“è€… OPS é•·æ¢åœ– ---
    if (battersData && battersData.length > 0) {
        const topBatters = battersData.sort((a, b) => (b.ops || 0) - (a.ops || 0)).slice(0, 15);
        
        const bTrace = {
            x: topBatters.map(p => p.name),
            y: topBatters.map(p => p.ops || 0),
            type: 'bar',
            // åŠ å…¥ customdata
            customdata: topBatters.map(p => p.id),
            marker: { 
                color: topBatters.map(p => p.ops || 0),
                colorscale: 'Greens',
                reversescale: true
            }
        };

        const bLayout = Object.assign({}, layoutConfig, {
            title: 'æ‰“è€… OPS (æ”»æ“ŠæŒ‡æ•¸) æ’è¡Œ',
            xaxis: Object.assign({}, layoutConfig.xaxis, { tickangle: -45 }),
            yaxis: Object.assign({}, layoutConfig.yaxis, { title: 'OPS' }),
            margin: { t: 50, b: 100, l: 60, r: 20 }
        });

        Plotly.newPlot('bar', [bTrace], bLayout, {displayModeBar: false});

        // ç¶å®šé»æ“Šäº‹ä»¶
        document.getElementById('bar').on('plotly_click', function(data){
            if(data.points.length > 0) {
                const playerId = data.points[0].customdata;
                if(playerId) window.location.href = `/player/${playerId}`;
            }
        });

    } else {
        document.getElementById('bar').innerHTML = '<div style="height:100%; display:flex; justify-content:center; align-items:center; color:#888;">ç„¡è¶³å¤ æ•¸æ“šç¹ªè£½åœ–è¡¨</div>';
    }
</script>
{% endblock %}