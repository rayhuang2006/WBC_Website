{% extends "base.html" %}

{% block content %}
<div class="dashboard-root">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
        <div>
            <h2 style="margin:0; font-size: 2rem; color: #fff;">{{ pool_name }} 戰力分析</h2>
        </div>
        <a href="/" class="nav-btn">&larr; Back</a>
    </header>

    <main style="display: flex; flex-direction: column; gap: 50px; width: 100%;">
        
        <section>
            <h3 style="color: var(--accent-blue); margin-bottom: 20px;">戰力雷達圖 (Radar Cards)</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                {% for team in teams %}
                <div class="interactive-card chart-card">
                    <h4 style="margin-bottom: 10px; color: #fff;">{{ team.name }}</h4>
                    <div id="team-{{ team.name }}-plot" style="width: 100%; height: 350px;"></div>
                </div>
                {% endfor %}
            </div>
        </section>

        <section class="interactive-card" style="cursor: default;">
            <h3 style="color: #fff; margin-bottom: 20px;">團隊數據比較</h3>
            <div id="barPlot" class="plotly-chart" style="width:100%; height:500px;"></div>
        </section>

        <section>
            <h3 style="color: #fff; margin-bottom: 20px;">參賽隊伍</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                {% for team in team_list %}
                <a href="/team/{{ team.name }}" class="interactive-card card-portrait" style="min-height: 250px;">
                    <div style="flex: 1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        {% if team.iso_code %}
                        <img src="{{ url_for('static', filename='flags/' + team.iso_code + '.png') }}" 
                             style="width: 80px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-radius: 8px;">
                        {% else %}
                        <div style="width:80px; height:50px; background:#555;"></div>
                        {% endif %}
                    </div>
                    <span style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">{{ team.name }}</span>
                </a>
                {% endfor %}
            </div>
        </section>

    </main>
</div>

<div id="flask-data" data-teams='{{ teams | tojson | safe }}' style="display:none;"></div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script src="//unpkg.com/d3"></script>
<script src="{{ url_for('static', filename='js/pool.js') }}"></script>

<script>
    const flaskData = JSON.parse(document.getElementById('flask-data').dataset.teams);
    
    // 全局深色設定 (重要！)
    window.PLOT_LAYOUT = {
        font: { color: '#e2e8f0' }, // 淺灰字
        paper_bgcolor: 'rgba(0,0,0,0)', // 全透明
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { gridcolor: '#334155' },
        yaxis: { gridcolor: '#334155' },
        autosize: true
    };

    document.addEventListener('DOMContentLoaded', function () {
        const hittingCsvUrl = "https://raw.githubusercontent.com/slps101023/Datasets/refs/heads/main/WBC%20Team_Hitting_Performance.csv";
        const pitchingCsvUrl = "https://raw.githubusercontent.com/slps101023/Datasets/refs/heads/main/WBC_Team_Pitching_Performance.csv";

        Promise.all([d3.csv(hittingCsvUrl), d3.csv(pitchingCsvUrl)])
        .then(res => {
            const allData = { flask: flaskData, hitting: res[0], pitching: res[1] };
            if (typeof drawRadarChart === 'function') drawRadarChart(allData);
            if (typeof drawBarChart === 'function') drawBarChart(allData);
        });
    });
</script>
{% endblock %}